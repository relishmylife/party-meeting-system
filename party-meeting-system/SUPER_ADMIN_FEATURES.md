# 超级管理员功能说明文档

## 部署信息
- **生产环境URL**: https://spj9n5ndyojc.space.minimaxi.com
- **构建时间**: 2025-11-29 20:10
- **版本**: v2.0 (超级管理员功能版)

## 超级管理员账户

### 账户信息
1. **王来老师**
   - 邮箱: wang_lai@imust.com
   - 密码: wang_lai123
   - 角色: super_admin

2. **李惠娟老师**
   - 邮箱: li_huijuan@imust.com
   - 密码: li_huijuan123
   - 角色: super_admin

## 权限系统升级

### 角色层级
- **super_admin** (超级管理员) - 最高权限
  - 拥有所有管理员权限
  - 额外拥有：数据库管理、批量消息、私信系统
  
- **admin** (管理员) - 中级权限
  - 用户管理、会议管理、统计分析
  
- **member** (普通党员) - 基础权限
  - 查看会议、接收通知、参与统计

### 权限判断逻辑
```typescript
isAdmin = profile?.role === 'admin' || profile?.role === 'super_admin'
isSuperAdmin = profile?.role === 'super_admin'
```

## 新增功能详解

### 1. 数据库管理 (Database Management)

**访问路径**: Dashboard → 数据库管理卡片

**功能特性**:
- **党员列表展示**
  - 表格化显示所有党员信息
  - 字段：姓名、手机号、党支部、职务、角色、状态
  - 角色徽章：超级管理员(金色)、管理员(红色)、普通党员(灰色)
  - 状态标签：正常(绿色)、停用(红色)

- **添加党员**
  - 必填字段：姓名、邮箱、密码、角色
  - 可选字段：手机号、党支部、职务
  - 自动创建认证账户和用户档案
  - 密码由管理员设置，用户可后续修改

- **编辑党员**
  - 修改基本信息：姓名、手机号、党支部、职务
  - 调整角色：管理员 ⟷ 普通党员
  - 注意：编辑时无法修改邮箱和密码

- **删除党员**
  - 带确认对话框，防止误删
  - 超级管理员账户受保护，不可删除
  - 删除操作会级联删除相关数据

- **数据安全**
  - 使用Supabase Admin API创建用户
  - RLS策略保护数据访问
  - 操作日志自动记录

### 2. 批量消息 (Batch Messaging)

**访问路径**: Dashboard → 批量消息卡片

**功能特性**:
- **党员选择**
  - 复选框多选模式
  - 实时显示已选人数
  - 快捷操作：全选、清空
  - 按党支部快速筛选

- **消息编辑**
  - 标题 + 内容格式
  - 提供消息模板：
    - 会议通知模板
    - 学习提醒模板
    - 活动通知模板
  - 支持自定义内容

- **发送功能**
  - 批量创建通知记录
  - 插入notifications表
  - 每个接收人一条记录
  - 显示发送成功提示

- **发送历史**
  - 查看历史消息记录
  - 显示标题、内容、接收人数
  - 按时间倒序排列
  - 最多显示最近20条

### 3. 私信系统 (Private Messaging)

**访问路径**: Dashboard → 私信系统卡片

**功能特性**:
- **党员列表**
  - 左侧显示所有可联系党员
  - 搜索功能：按姓名或党支部筛选
  - 角色标签：超管/管理/党员
  - 点击选择聊天对象

- **聊天界面**
  - 即时通讯式界面设计
  - 消息气泡：发送(蓝色右侧)、接收(灰色左侧)
  - 时间戳显示
  - 已读状态标记

- **发送消息**
  - 多行文本输入框
  - Enter键快速发送
  - Shift+Enter换行
  - 发送按钮带loading状态

- **实时更新**
  - 每5秒自动刷新消息
  - 切换聊天对象时立即刷新
  - 自动滚动到最新消息
  - 自动标记已读

- **数据存储**
  - 使用private_messages表
  - 字段：sender_id, recipient_id, content, read_at
  - RLS策略：用户只能查看自己的对话

## 界面设计

### Dashboard新增卡片
超级管理员登录后，Dashboard会额外显示3个功能卡片：

1. **数据库管理**
   - 图标：数据库图标
   - 标签：超管功能
   - 边框：金色强调边框
   - 描述：党员信息增删改查，批量导入导出

2. **批量消息**
   - 图标：消息气泡图标
   - 标签：超管功能
   - 边框：金色强调边框
   - 描述：批量给党员发送通知消息

3. **私信系统**
   - 图标：对话框图标
   - 标签：超管功能
   - 边框：金色强调边框
   - 描述：党员间一对一私信沟通

### 配色方案
- **主色调**: 保持红-金-白配色
- **超管标识**: 金色(accent)突出显示
- **功能卡片**: 金色边框区分超管功能
- **角色徽章**: 
  - 超级管理员: bg-accent-100 text-accent-700
  - 管理员: bg-primary-100 text-primary-700
  - 普通党员: bg-neutral-100 text-neutral-600

## 数据库变更

### 新增表: private_messages
```sql
CREATE TABLE private_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sender_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  recipient_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  read_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### RLS策略
1. **查看权限**: 用户可以查看自己发送或接收的消息
2. **插入权限**: 用户可以发送消息（sender_id必须是自己）
3. **更新权限**: 用户可以标记接收的消息为已读
4. **删除权限**: 用户可以删除自己发送或接收的消息

### 索引优化
- `idx_private_messages_sender`: sender_id索引
- `idx_private_messages_recipient`: recipient_id索引
- `idx_private_messages_created_at`: created_at索引

## 测试指南

### 1. 登录测试
- 使用超级管理员账户登录
- 验证顶部显示"超级管理员"角色标签
- 检查Dashboard是否显示3个超管功能卡片

### 2. 数据库管理测试
- 点击"数据库管理"卡片进入页面
- 测试添加党员功能
- 测试编辑党员信息
- 测试删除党员（验证超管不可删除）
- 检查表格显示和角色徽章

### 3. 批量消息测试
- 点击"批量消息"卡片进入页面
- 测试党员多选功能
- 测试消息模板应用
- 发送测试消息给选中党员
- 查看发送历史记录

### 4. 私信系统测试
- 点击"私信系统"卡片进入页面
- 选择一个党员开始对话
- 发送测试消息
- 验证消息实时刷新
- 检查已读状态更新

### 5. 权限验证测试
- 使用普通管理员账户登录
- 验证无法看到超管功能卡片
- 尝试直接访问超管页面（应显示权限不足）

## 技术栈

### 前端
- React 18 + TypeScript
- TailwindCSS (自定义主题)
- Vite (构建工具)

### 后端
- Supabase
  - PostgreSQL数据库
  - 认证系统
  - RLS安全策略
  - Admin API

### UI组件库
- 自定义组件系统
- Button, Toast, ConfirmDialog
- LoadingSpinner, EmptyState
- 响应式设计

## 注意事项

1. **安全性**
   - 超级管理员权限谨慎授予
   - 定期审查用户角色分配
   - 删除操作不可恢复，需谨慎确认

2. **性能优化**
   - 私信系统有5秒轮询，大量消息时注意性能
   - 批量消息发送时，接收人过多可能较慢
   - 数据库查询已添加索引优化

3. **用户体验**
   - 所有操作都有loading状态提示
   - 重要操作有确认对话框
   - 成功/失败都有toast提示

4. **数据一致性**
   - 添加党员会同时创建auth.users和user_profiles记录
   - 删除党员会级联删除相关数据
   - 私信消息支持软删除（未来可扩展）

## 后续扩展建议

1. **批量导入导出**
   - Excel文件批量导入党员信息
   - 导出党员信息到Excel
   - 数据验证和错误处理

2. **消息模板管理**
   - 允许超管自定义消息模板
   - 模板分类和标签
   - 模板使用统计

3. **私信增强**
   - 消息撤回功能
   - 图片/文件发送
   - 消息搜索功能
   - 未读消息提醒徽章

4. **操作日志**
   - 记录所有超管操作
   - 审计日志查询
   - 操作统计报表

## 联系方式
如有问题或建议，请联系系统管理员。

---
**文档版本**: v2.0  
**更新时间**: 2025-11-29  
**维护者**: Matrix Agent
